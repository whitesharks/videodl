<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VideoDL WebUI</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2f;
      --panel2:#0f1930;
      --text:#e8edf7;
      --muted:#a9b6d0;
      --line:rgba(255,255,255,.08);
      --btn:#2b66ff;
      --btn2:#1c2b50;
      --danger:#ff4d4f;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#1b2a52;
      --chip2:#142144;
    }
    body{ background:linear-gradient(180deg,#060a14, var(--bg)); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin:0; padding:24px;}
    h1{ margin:0 0 12px 0; font-size:22px; }
    h2{ margin:0 0 10px 0; font-size:16px; color:var(--text); }
    .sub{ color:var(--muted); font-size:12px; margin-bottom:18px; }
    code{ background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
    .row{ display:grid; grid-template-columns: 1.2fr 1fr 1fr; gap:16px; align-items:start; }
    @media (max-width: 1100px){ .row{ grid-template-columns:1fr; } }
    .card{ background:rgba(16,26,47,.9); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.25); }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, textarea{
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.04); color:var(--text); padding:10px;
      outline:none;
    }
    input:focus, textarea:focus{ border-color:rgba(43,102,255,.7); box-shadow:0 0 0 3px rgba(43,102,255,.15); }
    .btn{ background:var(--btn); color:white; border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:var(--btn2); font-weight:600; }
    .btn.danger{ background:rgba(255,77,79,.14); color:#ffd6d6; border:1px solid rgba(255,77,79,.35); }
    .btn.small{ padding:6px 10px; border-radius:10px; font-weight:600; font-size:12px; }
    .line{ height:1px; background:var(--line); margin:14px 0; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }
    .chip{ background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 600px){ .grid2{ grid-template-columns:1fr; } }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th,td{ padding:10px 8px; border-bottom:1px solid var(--line); font-size:12px; vertical-align:top; }
    th{ color:var(--muted); font-weight:600; }
    .urlcell{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    a{ color:#9cc0ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .badge{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:var(--chip2); color:var(--muted); }
    .b-ok{ color:#c8ffe0; background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.35); }
    .b-run{ color:#d3e6ff; background:rgba(43,102,255,.15); border-color:rgba(43,102,255,.35); }
    .b-q{ color:#ffe9c7; background:rgba(245,158,11,.14); border-color:rgba(245,158,11,.35); }
    .b-bad{ color:#ffd1d1; background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.35); }
    .b-stop{ color:#e6e6e6; background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.12); }

    .checkline{ display:flex; gap:10px; align-items:center; margin-top:10px; }
    .checkline input{ width:auto; }
    .muted{ color:var(--muted); font-size:12px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* header right version */
    .topbar{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
    .versions{ text-align:right; font-size:12px; color:var(--muted); line-height:1.6; }
    .versions b{ color:var(--text); font-weight:700; }

    /* pagination */
    .pager{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .pager .left{ color:var(--muted); font-size:12px; }
    .pager .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pager a{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.04); }
    .pager a.disabled{ pointer-events:none; opacity:.45; }
    .pager .cur{ padding:6px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--text); font-size:12px; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:20px;
    }
    .modal{
      width:min(520px, 96vw);
      background:rgba(16,26,47,.98);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:16px;
    }
    .modal h3{ margin:0 0 8px 0; font-size:16px; }
    .modal .hint{ color:var(--muted); font-size:12px; line-height:1.6; }
    .modal .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>VideoDL WebUI</h1>
      <div class="sub">
        下载目录：<code>{{ download_dir }}</code> |
        任务目录：<code>{{ tasks_dir }}</code> |
        运行中：<b>{{ running_count }}</b>/<b>{{ settings.max_concurrent }}</b>
        <div class="chips">
          <span class="chip">并发上限：{{ settings.max_concurrent }}</span>
          <span class="chip">日志保留：{{ settings.log_retention_days }} 天</span>
          <span class="chip">任务超时：{{ settings.task_timeout }} 秒</span>
          <span class="chip">代理：{{ settings.proxy_url if settings.proxy_url else "未配置" }}</span>
          <span class="chip">文件缓存：{{ files_cache_ts|fmt_ts }}</span>
        </div>
      </div>
    </div>

    <div class="versions">
      <div>VideoDL：<b>{{ videodl_version }}</b></div>
      <div>WebUI：<b>{{ webui_version }}</b></div>
    </div>
  </div>

  <div class="row">
    <!-- Create Task + Settings -->
    <div class="card">
      <h2>新建下载任务</h2>
      <form method="post" action="/tasks">
        <label>视频 URL</label>
        <input name="url" placeholder="https://..." required />

        <label>额外参数（可选）</label>
        <textarea name="extra_args" rows="3" placeholder='例如：-a 2 -g 1 （不建议填写输出路径参数）'></textarea>
        <div class="muted">参数会拼到 <code>videodl -i URL</code> 后面（已做安全过滤，阻止明显路径逃逸）。<br/>更多参数使用：详见https://github.com/CharlesPikachu/videodl <br/>本项目Docker镜像：whitesharks/videodl-webui</div>

        <div class="checkline">
          <input id="use_proxy" type="checkbox" name="use_proxy" />
          <label for="use_proxy" style="margin:0; color:var(--text);">启用代理（使用下方“运行设置”中的全局代理）</label>
        </div>

        <div style="height:10px"></div>
        <button class="btn" type="submit">加入队列 / 开始下载</button>
      </form>

      <br/>
	  <div class="line"></div>
	  <br/>

      <h2>运行设置</h2>
      <form method="post" action="/settings">
        <div class="grid2">
          <div>
            <label>并发上限</label>
            <input name="max_concurrent" type="number" min="1" value="{{ settings.max_concurrent }}" required />
          </div>
          <div>
            <label>日志保留天数（清理 run.log）</label>
            <input name="log_retention_days" type="number" min="1" value="{{ settings.log_retention_days }}" required />
          </div>
          <div>
            <label>单任务超时（秒）</label>
            <input name="task_timeout" type="number" min="60" value="{{ settings.task_timeout }}" required />
          </div>
          <div>
            <label>全局代理（http/https/socks5）</label>
            <input name="proxy_url" placeholder="例如：http://127.0.0.1:7890" value="{{ settings.proxy_url }}" />
          </div>
        </div>

        <div style="height:10px"></div>
        <button class="btn secondary" type="submit">保存设置</button>
        <div class="muted" style="margin-top:8px;">设置保存后立即生效；任务勾选“启用代理”才会使用该代理。</div>
      </form>
    </div>

    <!-- Tasks -->
    <div class="card">
      <h2>任务列表</h2>
      <table>
        <thead>
          <tr>
            <th style="width:140px;">ID</th>
            <th style="width:92px;">状态</th>
            <th>URL</th>
            <th style="width:160px;">操作</th>
          </tr>
        </thead>
        <tbody>
        {% for t in tasks %}
          <tr>
            <td><a href="/tasks/{{ t.id }}">{{ t.id }}</a></td>
            <td>
              {% if t.status == "success" %}
                <span class="badge b-ok">success</span>
              {% elif t.status == "failed" %}
                <span class="badge b-bad">failed</span>
              {% elif t.status == "running" %}
                <span class="badge b-run">running</span>
              {% elif t.status == "queued" %}
                <span class="badge b-q">queued</span>
              {% elif t.status == "stopped" %}
                <span class="badge b-stop">stopped</span>
              {% else %}
                <span class="badge">{{ t.status }}</span>
              {% endif %}
              {% if t.use_proxy %}<div class="muted">proxy</div>{% endif %}
            </td>
            <td class="urlcell" title="{{ t.url }}">{{ t.url }}</td>
            <td>
              <div class="actions">
                <a class="btn small secondary" href="/tasks/{{ t.id }}">详情</a>
                <button class="btn small danger" type="button" onclick="openDeleteModal('{{ t.id }}')">删除</button>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div class="pager">
        <div class="left">共 {{ tasks_total }} 条，当前第 {{ tasks_page }}/{{ tasks_total_pages }} 页</div>
        <div class="right">
          <a href="/?task_page=1&file_page={{ files_page }}" class="{{ 'disabled' if tasks_page<=1 else '' }}">首页</a>
          <a href="/?task_page={{ tasks_page-1 }}&file_page={{ files_page }}" class="{{ 'disabled' if tasks_page<=1 else '' }}">上一页</a>
          <span class="cur">{{ tasks_page }}</span>
          <a href="/?task_page={{ tasks_page+1 }}&file_page={{ files_page }}" class="{{ 'disabled' if tasks_page>=tasks_total_pages else '' }}">下一页</a>
          <a href="/?task_page={{ tasks_total_pages }}&file_page={{ files_page }}" class="{{ 'disabled' if tasks_page>=tasks_total_pages else '' }}">末页</a>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        并发上限以内任务会自动开始；超过上限的任务会 queued，等待调度。
      </div>
    </div>

    <!-- Files -->
    <div class="card">
      <h2>已下载文件</h2>
      <div class="muted">
        文件缓存更新时间：<b>{{ files_cache_ts|fmt_ts }}</b>（后台每 10 分钟刷新；页面也每 10 分钟自动刷新）
      </div>

      <div style="height:10px"></div>

      <table>
        <thead>
          <tr>
            <th>路径</th>
            <th style="width:120px;">大小</th>
            <th style="width:160px;">操作</th>
          </tr>
        </thead>
        <tbody>
        {% for f in files %}
          <tr>
            <td class="urlcell" title="{{ f.path }}">
              <a href="/files/{{ f.path }}">{{ f.path }}</a>
              <div class="muted">mtime: {{ f.mtime|fmt_ts }}</div>
            </td>
            <td>{{ f.size|fmt_bytes }}</td>
            <td>
              <form method="post" action="/files/{{ f.path }}/delete" onsubmit="return confirm('确定删除该文件？');">
                <button class="btn small danger" type="submit">删除文件</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div class="pager">
        <div class="left">共 {{ files_total }} 条，当前第 {{ files_page }}/{{ files_total_pages }} 页</div>
        <div class="right">
          <a href="/?task_page={{ tasks_page }}&file_page=1" class="{{ 'disabled' if files_page<=1 else '' }}">首页</a>
          <a href="/?task_page={{ tasks_page }}&file_page={{ files_page-1 }}" class="{{ 'disabled' if files_page<=1 else '' }}">上一页</a>
          <span class="cur">{{ files_page }}</span>
          <a href="/?task_page={{ tasks_page }}&file_page={{ files_page+1 }}" class="{{ 'disabled' if files_page>=files_total_pages else '' }}">下一页</a>
          <a href="/?task_page={{ tasks_page }}&file_page={{ files_total_pages }}" class="{{ 'disabled' if files_page>=files_total_pages else '' }}">末页</a>
        </div>
      </div>

      <div style="height:10px"></div>
      <button class="btn small secondary" onclick="forceRefreshFiles()">立即刷新文件列表</button>
    </div>
  </div>

  <!-- Delete modal -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="onBackdropClick(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>删除任务</h3>
      <div class="hint">
        将删除该任务的记录（任务详情/日志）。<br/>
        如果勾选“同时删除文件”，将递归删除 <code>downloads/&lt;task_id&gt;/</code> 整个目录（包含目录本身）。
      </div>

      <div class="checkline" style="margin-top:12px;">
        <input id="deleteFilesChk" type="checkbox" />
        <label for="deleteFilesChk" style="margin:0; color:var(--text);">同时删除文件（删除整个任务目录）</label>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" type="button" onclick="closeDeleteModal()">取消</button>
        <button class="btn danger" type="button" onclick="submitDelete()">确认删除</button>
      </div>

      <form id="deleteForm" method="post" style="display:none;">
        <input id="deleteDownloadsVal" type="hidden" name="delete_downloads" value="0" />
      </form>
    </div>
  </div>

<script>
  async function forceRefreshFiles(){
    try{
      await fetch("/files/refresh", { method: "POST" });
      location.reload();
    }catch(e){}
  }
  // 10分钟自动刷新（解决删除后列表不更新）
  setInterval(forceRefreshFiles, 600000);

  // modal logic
  let currentDeleteTaskId = "";

  function openDeleteModal(taskId){
    currentDeleteTaskId = taskId;
    document.getElementById("deleteFilesChk").checked = false;
    document.getElementById("modalBackdrop").style.display = "flex";
  }

  function closeDeleteModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    currentDeleteTaskId = "";
  }

  function onBackdropClick(e){
    // 点击遮罩关闭
    closeDeleteModal();
  }

  function submitDelete(){
    if(!currentDeleteTaskId) return;
    const delFiles = document.getElementById("deleteFilesChk").checked;
    const form = document.getElementById("deleteForm");
    form.action = `/tasks/${currentDeleteTaskId}/delete`;
    document.getElementById("deleteDownloadsVal").value = delFiles ? "1" : "0";
    form.submit();
  }
</script>
</body>
</html>
